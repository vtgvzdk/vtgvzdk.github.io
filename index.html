<!DOCTYPE html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jazykový experiment</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 text-gray-900">
    <main id="app" class="max-w-2xl mx-auto p-6"></main>

    <script>
      (() => {
        const QUESTIONS_URL =
          "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQkPVIxQawAyPBf6YjqrMfBp11ghaQakJ_VdGm-6eI8nodVc_h3o-ZJPv5Dbax7F-BwmWn0UlgdCns/pub?output=csv";
        const ENDPOINT_URL =
          "https://script.google.com/macros/s/AKfycbzfSqGxk-FtOo06LA0W16YHlLRDIkvvxo8_Ze_mfI00tSsxVmfJGPv5CgdxrRX9pcOW/exec";

        let questions = [];
        let shuffled = [];
        let currentIndex = 0;
        const responses = {};
        let respondentId = "";
        let respondentEmail = "";
        const app = document.getElementById("app");

        function hashEmail(email) {
          return btoa(unescape(encodeURIComponent(email))).slice(0, 24);
        }

        async function loadQuestions(url) {
          const res = await fetch(url);
          const txt = await res.text();
          try {
            const json = JSON.parse(txt);
            return json.map((row, i) => ({
              id: row.id ?? i + 1,
              context: row.context ?? row.A ?? "",
              sentence: row.sentence ?? row.B ?? "",
              options: [row.C ?? "", row.D ?? ""],
            }));
          } catch {
            const lines = txt.trim().split(/\r?\n/);
            const parse = (l) =>
              l.match(/("[^"]*"|[^,]+)/g).map((x) => x.replace(/^"|"$/g, ""));
            return lines.slice(1).map((l, i) => {
              const c = parse(l);
              return {
                id: i + 1,
                context: c[0] ?? "",
                sentence: c[1] ?? "",
                options: [c[2] ?? "", c[3] ?? ""],
              };
            });
          }
        }

        const shuffle = (arr) => {
          const a = [...arr];
          for (let i = a.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [a[i], a[j]] = [a[j], a[i]];
          }
          return a;
        };

        function sendToSheet(partial = false) {
          const payload = {
            respondentId,
            email: respondentEmail,
            timestamp: Date.now(),
            responses,
            partial,
          };
          fetch(ENDPOINT_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          }).catch((e) => console.error("POST error", e));
        }

        function renderIntro() {
  app.innerHTML = INTRO_HTML + `<div class='text-center mt-6'><button id="restartBtn" class="mt-4 text-sm text-gray-600 underline hover:text-gray-900">Začít znovu</button></div>`;
  const restart = document.getElementById("restartBtn");
  restart.addEventListener("click", () => {
    const key = `exp_${respondentId}`;
    localStorage.removeItem(key);
    location.reload();
  });
    const emailInput = app.querySelector("#email");
  const startBtn = app.querySelector("#startBtn");
  emailInput.addEventListener("input", () => {
    startBtn.disabled = !emailInput.checkValidity();
  });
  startBtn.addEventListener("click", async () => {
    respondentEmail = emailInput.value.trim();
    respondentId = hashEmail(respondentEmail);
    const storageKey = `exp_${respondentId}`;

    const stored = localStorage.getItem(storageKey);
    if (stored) {
      const { savedResponses } = JSON.parse(stored);
      Object.assign(responses, savedResponses);
    }

    const unanswered = shuffle(questions).filter(q => !responses[q.id]);

    if (Object.keys(responses).length > 0 && unanswered.length > 0) {
      app.innerHTML = `<section class="bg-white shadow rounded-2xl p-8 space-y-4 animate-fadeIn">
        <p>Zdá se, že jste již část experimentu absolvoval(a). Chcete pokračovat, kde jste skončil(a), nebo začít znovu?</p>
        <div class="flex gap-4">
          <button id="continueBtn" class="flex-1 bg-gray-400 text-white py-2 rounded-xl shadow hover:bg-gray-800 transition">Pokračovat</button>
          <button id="restartBtn" class="flex-1 bg-white border border-gray-400 text-gray-800 py-2 rounded-xl shadow hover:bg-gray-200 transition">Začít znovu</button>
        </div>
      </section>`;

      document.getElementById("continueBtn").addEventListener("click", () => {
        shuffled = unanswered;
        currentIndex = 0;
        sendToSheet(true);
        renderQuestion();
      });

      document.getElementById("restartBtn").addEventListener("click", () => {
        localStorage.removeItem(storageKey);
        location.reload();
      });

    } else if (unanswered.length === 0 && Object.keys(responses).length === questions.length) {
      app.innerHTML = `<section class="bg-white shadow rounded-2xl p-8 text-center animate-fadeIn">
        <h1 class="text-2xl font-bold mb-4">Experiment již absolvován</h1>
        <p>Děkujeme, ale podle našich údajů jste již odpověděl(a) na všechny otázky.</p>
      </section>`;
    } else {
      shuffled = unanswered;
      currentIndex = 0;
      sendToSheet(true);
      renderQuestion();
    }
    
  });
}

function renderQuestion() {
  if (currentIndex >= shuffled.length) {
    finish();
    return;
  }

  const q = shuffled[currentIndex];

  const originalOptions = q.options.map((opt, idx) => ({
    text: opt,
    label: idx === 0 ? 'A' : 'B'
  }));

  const randomizedOptions = shuffle(originalOptions);

  const answered = Object.keys(responses).length;
  const progressPercent = (answered / questions.length) * 100;
  
  app.innerHTML = `
    <section class="bg-white shadow rounded-2xl p-8 animate-fadeIn">
      <div class="w-full bg-gray-300 h-3 rounded-full mb-6 overflow-hidden">
        <div class="bg-gray-800 h-3" style="width:${progressPercent}%"></div>
      </div>
      <p class="mb-4 whitespace-pre-line">${q.context}</p>
      <p class="mb-6"><em>${q.sentence}</em></p>
      <form id="qForm" class="space-y-4">
        ${randomizedOptions
          .map(
            (opt, i) => `<label class="flex items-center gap-3 cursor-pointer">
              <input type="radio" name="answer" value="${i}" class="h-5 w-5 accent-gray-800" />
              <span>${opt.text}</span> <!-- ✅ zde správně zobrazuješ text možnosti -->
            </label>`
          )
          .join("")}
        <button type="submit" class="mt-6 w-full bg-gray-400 text-white py-2 rounded-xl shadow hover:bg-gray-800 transition">
          ${currentIndex === shuffled.length - 1 ? "Odeslat" : "Další"}
        </button>
      </form>
    </section>`;

  const form = document.getElementById("qForm");
  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const choice = form.querySelector("input[name='answer']:checked");
    if (!choice) return alert("Prosím, vyberte jednu z možností.");
    responses[q.id] = randomizedOptions[choice.value].label;  // ✅ uložíme správné A/B podle původu

    const storageKey = `exp_${respondentId}`;
    localStorage.setItem(storageKey, JSON.stringify({
      savedResponses: responses
    }));

    sendToSheet(true);
    currentIndex++;
    renderQuestion();
  });
}

        function finish() {
          sendToSheet(false);
          app.innerHTML = `<section class="bg-white shadow rounded-2xl p-8 text-center animate-fadeIn"><h1 class="text-2xl font-bold mb-4">Děkujeme za účast!</h1><p>Vaše odpovědi byly zaznamenány.</p></section>`;
        }

        const INTRO_HTML = `
          <section class="bg-white shadow rounded-2xl p-8 space-y-6 animate-fadeIn">
            <h1 class="text-2xl font-bold">Díky, že jste se rozhodli zúčastnit online experimentu zaměřeného na rozhodování.</h1>
            <h2 class="text-lg font-semibold">Co vás čeká?</h2>
            <p>Celkem projdete <strong>48 samostatných situací</strong>. Každá situace obsahuje stručný popis kontextu a jedno souvětí, které si postava v dané situaci říká.</p>
            <h2 class="text-lg font-semibold">Váš úkol</h2>
            <p>Na základě kontextu a daného souvětí vyberte ze dvou nabízených možností ten závěr, který podle vás daná osoba v dané situaci učiní.</p>
            <h2 class="text-lg font-semibold">Důležité</h2>
            <ul class="list-disc list-inside space-y-1">
              <li>Neberte v úvahu, co byste v této situaci udělali <strong>vy osobně</strong>.</li>
              <li>Zaměřte se výhradně na perspektivu a pravděpodobné uvažování dané postavy v dané situaci s ohledem na dané souvětí.</li>
            </ul>
            <h2 class="text-lg font-semibold">Praktické informace</h2>
            <ul class="list-disc list-inside space-y-1">
              <li>Experiment není časově omezen, ale většina účastníků a účastnic ho dokončí za <strong>15 až 20&nbsp;minut</strong>.</li>
              <li>Odpovědi nejsou „správné“ či „špatné“ v tradičním smyslu. Zajímá mě výhradně to, jak interpretujete chování dané postavy.</li>
              <li>Data, která experiment sbírá, budou v <strong>anonymizované</strong> podobě využita (i) pro stanovení základní lidské úrovně odpovědí na otázky tohoto datasetu (v rámci projektu LINDAT LM2023062) a (ii) dále v komparativním výzkumu chování velkých jazykových modelů. Zadáním emailu níže s tímto užitím souhlasíte.</li>
              <li>Máte-li dotazy či komentáře, obraťte se na autora experimentu, dr. Víta Gvoždiaka (<a href="mailto:gvozdiak@flu.cas.cz">gvozdiak@flu.cas.cz</a>).</li>
            </ul>
            <p>Díky za spolupráci!</p>
            <div class="space-y-2 pt-4">
              <label for="email" class="block font-medium">Váš e‑mail:</label>
              <input id="email" type="email" required autocomplete="email" class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring focus:border-gray-700" />
            </div>
            <button id="startBtn" disabled class="w-full bg-gray-400 text-white py-2 rounded-xl shadow transition hover:bg-gray-800 disabled:opacity-50 disabled:cursor-not-allowed">Začít</button>
          </section>`;

        (async () => {
          try {
            questions = await loadQuestions(QUESTIONS_URL);
            if (!questions.length) throw new Error("Seznam otázek je prázdný");
            renderIntro();
          } catch (err) {
            console.error(err);
            questions = [];
            renderIntro();
          }
        })();
      })();
    </script>
  </body>
</html>